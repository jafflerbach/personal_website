---
title: Cropping rasters down to size
author: Jamie Afflerbach
date: '2018-04-19'
slug: cropping-rasters-down-to-size
categories: []
tags: ["spatial", "Ocean Health Index"]
---



<p>A significant portion of my work on the Ocean Health Index (OHI) involves working with <a href="http://desktop.arcgis.com/en/arcmap/10.3/manage-data/raster-and-images/what-is-raster-data.htm">raster data</a>, a specific type of spatial data where values are held in grid cells. The data I work with varies from high resolution remotely sensed data on <a href="https://www.nodc.noaa.gov/sog/cortad/">sea surface temperature</a> to coarse, modeled data on global <a href="http://www.seaaroundus.org/data/#/spatial-catch">fish catch</a>. When I was working on the <a href="http://ohi-science.org/ohi-global/">global assessment</a>, I dealt with raster data at a global scale.</p>
<div class="figure">
<img src="/img/example_rasters.png" />

</div>
<p>Now that I’m working on a regional assessment in the <a href="http://www.ohi-northeast.org/">US Northeast</a>, I often need to use the same data from the global assessment but crop it to my regional scale. Since I know I’m not the only one doing this (we have <a href="http://ohi-science.org/projects/ohi-assessments/">over 20 OHI+ assessments happening around the world</a> right now), I wanted to share my process for making our global raster layers usable at regional scales.</p>
<p>To demonstrate how to crop a global raster layer to a regional scale, we’ll do the following:</p>
<ol style="list-style-type: decimal">
<li>Read in a global mangrove dataset</li>
<li>Select a single country’s boundary from the OHI global region file</li>
<li><code>crop</code> and <code>mask</code> the mangrove data to the region scale</li>
</ol>
<p>The libraries you will need are <a href="https://cran.r-project.org/web/packages/raster/vignettes/Raster.pdf"><code>raster</code></a>, <a href="https://r-spatial.github.io/sf/"><code>sf</code></a> and <a href="https://dplyr.tidyverse.org/"><code>dplyr</code></a>.</p>
<pre class="r"><code>library(raster)
library(sf)
library(dplyr)</code></pre>
<div id="get-raster-data" class="section level2">
<h2>Get raster data</h2>
<p>Here is a raster that contains global mangrove data. Since this file is too large to hold on github, I am accessing a copy we have on a server at NCEAS. You can download it <a href="https://ohi.nceas.ucsb.edu/data/data/mangrove_2012_mw_km2.tif">here</a>.</p>
<p>Some important information about this dataset:</p>
<blockquote>
<p>This is a slightly modified version of the “MFW, Mangrove Forest Cover Loss since 2000 in areas with year 2000 Mangrove Forest” dataset from: Hamilton, S. E., &amp; Casey, D. (2016). <a href="http://faculty.salisbury.edu/~sehamilton/mangroves/index.html">Creation of a high spatio-temporal resolution global database of continuous mangrove forest cover for the 21st century (CGMFC-21)</a>. Global Ecology and Biogeography, 25(6), 729-738. <a href="doi:10.1111/geb.1244" class="uri">doi:10.1111/geb.1244</a>.</p>
<p>Because the 30m resolution raster the data is provided as (although awesome!) can be difficult to work with, we created a ~500m resolution raster and converted to a Mollweide coordinate reference system. The units are km2 mangrove per cell, consequently, summing the raster cells in a region will provide the km2 area of mangrove forest (cell values range from 0 to 0.274979).</p>
<p>The scripts we used to estimate mangrove extent and trend are available from <a href="https://github.com/OHI-Science/ohiprep/tree/master/globalprep/hab_mangrove/v2015">github</a>.</p>
<p>These data could be useful for estimating mangrove cover in regions without local mangrove surveys.</p>
</blockquote>
<p>Let’s just take a look at the raw data. Since mangroves tend to be limited to coastal regions at tropical latitudes, it is difficult to make sense of this data when visualizing it at a global scale, even when I make all cells black in color. This is also due to the high resolution of the data.</p>
<p>Can you see the dots!?</p>
<pre class="r"><code>mangrove &lt;- raster(file.path(dir_M, &#39;git-annex/globalprep/Mangrove/v2015/tmp/mangrove_2012_mw/mangrove_2012_mw_km2.tif&#39;))

par(mar = c(0.1, 0.1, 0.1, 0.1))
plot(mangrove, col = &quot;black&quot;, axes = F)</code></pre>
<p><img src="/post/2018-04-18-cropping-rasters-down-to-size-mangroves_files/figure-html/mangrove-1.png" width="672" /></p>
<p>Fortunately, R gives us some options to explore the data more closely. We can zoom in using <code>raster::select()</code> to make more sense of the speckles we see currently. The <code>select()</code> function allows you to select an area on the plot with your cursor. By saving your selection to a variable (in our case <code>s</code>) you can then plot just that piece of the raster.</p>
<div class="figure">
<img src="/img/select_mangrove.gif" />

</div>
<p>OK that looks more like it!</p>
</div>
<div id="get-region-polygon" class="section level2">
<h2>Get region polygon</h2>
<p>We provide a shapefile of our global regions, which can be loaded and filtered for any of the 240 regions we include. This is useful for anyone that wants to use data provided at the global level, but cropped down to a region of interest. You can click and download the shapefile <a href="https://mazu.nceas.ucsb.edu/data/#ohi_regions">here</a>. I will download it onto my personal computer and save it in a folder called <code>data</code>.</p>
<div class="figure">
<img src="/img/eezs.png" />

</div>
<pre class="r"><code># The primary spatial polygon file is &quot;regions&quot;
download.file(&quot;https://ohi.nceas.ucsb.edu/data/data/regions.zip&quot;, destfile = &quot;data/ohi-global-regions.zip&quot;, quiet = TRUE)

#unzip file
unzip(&quot;data/ohi-global-regions.zip&quot;,exdir=&quot;data/regions&quot;)</code></pre>
<p>Once downloaded, you will have two different regions files, one in <strong>Mollweide</strong> and one in <strong>WGS84</strong>. You can select which suits your needs. If you need more information on coordinate reference systems see <a href="https://www.nceas.ucsb.edu/~frazier/RSpatialGuides/OverviewCoordinateReferenceSystems.pdf">here</a>.</p>
<p>Since the mangrove data is already in a Mollweide projection, we will use the regions file in the same projection, <code>regions_mol</code>. I’m going to use the function <code>st_read()</code> to load the shapefile. This comes from the <code>sf</code> package and I think it is a cleaner way of loading and working with spatial data as opposed to using <code>readOGR()</code> from the <code>rgdal</code> package. But, as you’ll see later, when working with both polygons and rasters it is often necessary to convert a simple feature object to a <code>SpatialPolygonsDataFrame</code>.</p>
<pre class="r"><code>## use st_read to read in the global regions shapefile as a Simple Feature object
regions &lt;- st_read(&quot;data/regions/regions_mol.shp&quot;)</code></pre>
<pre><code>## Reading layer `regions_mol&#39; from data source `/home/afflerbach/github/personal_website/content/post/data/regions/regions_mol.shp&#39; using driver `ESRI Shapefile&#39;
## Simple feature collection with 551 features and 7 fields
## geometry type:  MULTIPOLYGON
## dimension:      XY
## bbox:           xmin: -18040060 ymin: -9020048 xmax: 18040080 ymax: 9020048
## epsg (SRID):    NA
## proj4string:    +proj=moll +lon_0=0 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs</code></pre>
<p>The <code>regions</code> object is a Simple feature with an attribute table that lists some important variables including the type of region (land or eez), name, three-letter key and total area.</p>
<pre class="r"><code>head(regions)</code></pre>
<pre><code>## Simple feature collection with 6 features and 7 fields
## geometry type:  MULTIPOLYGON
## dimension:      XY
## bbox:           xmin: 883504 ymin: -1914692 xmax: 16892390 ymax: 458736.6
## epsg (SRID):    NA
## proj4string:    +proj=moll +lon_0=0 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs
##   rgn_typ ant_typ rgn_id ant_id             rgn_nam rgn_key      are_km2
## 1     eez     eez      1      1       Cocos Islands     CCK 470116.60060
## 2    land    land      1      1       Cocos Islands     CCK     17.94724
## 3     eez     eez     10     10               Nauru     NRU 310565.14721
## 4    land    land     10     10               Nauru     NRU     22.78557
## 5     eez     eez    100    100 Republique du Congo     COG  39863.59682
## 6    land    land    100    100 Republique du Congo     COG 346305.36416
##                         geometry
## 1 MULTIPOLYGON (((9921659.093...
## 2 MULTIPOLYGON (((9573533.319...
## 3 MULTIPOLYGON (((16870312.59...
## 4 MULTIPOLYGON (((16730961.91...
## 5 MULTIPOLYGON (((1200386.757...
## 6 MULTIPOLYGON (((1172410.299...</code></pre>
<p>Let’s plot the object to make sure what we have is what we expect. With simple features, you need to tell plot which column to show, otherwise R will create a plot for every column which we don’t need! Here I’m plotting just the <code>rgn_id</code> column, which is the third column.</p>
<pre class="r"><code>plot(regions[3])</code></pre>
<p><img src="/post/2018-04-18-cropping-rasters-down-to-size-mangroves_files/figure-html/plot_rgns-1.png" width="672" /></p>
<p>For the sake of demonstration we are going to use Bangladesh as our region of interest. Since we loaded the shapefile as a simple feature object, we can easily select Bangladesh using <code>filter()</code> from the <code>dplyr</code> package. When we plot our new object, we see there are two distinct polygons included - the land and eez polygons for Bangladesh.</p>
<pre class="r"><code># filter the regions you want:
bangladesh &lt;- regions %&gt;% 
  filter(rgn_nam == &quot;Bangladesh&quot;)

plot(bangladesh[1])</code></pre>
<p><img src="/post/2018-04-18-cropping-rasters-down-to-size-mangroves_files/figure-html/plot_region-1.png" width="672" /></p>
<p>This looks like what we want so I recommend saving this object with <code>st_write()</code> to use in other parts of your analysis.</p>
<pre class="r"><code># save the output (saving as an ESRI Shapefile):
write_sf(bangladesh, &quot;data/bangladesh.shp&quot;)</code></pre>
</div>
<div id="crop-raster-data-to-region-extent" class="section level2">
<h2>Crop raster data to region extent</h2>
<p>Unfortunately, rasters don’t yet play nicely with Simple Features, so we need to convert the <code>bangladesh</code> object to a <code>SpatialPolygonsDataFrame</code>. This is done quickly using the <code>as()</code> function from the sf package. You simply feed your simple feature object, in our case it is <code>bangladesh</code> to <code>as()</code> and tell it to convert to a <code>Spatial</code> object. This returns a <code>SpatialPolygonsDataFrame</code>.</p>
<pre class="r"><code>bang_sp &lt;- as(bangladesh, &#39;Spatial&#39;)
bang_sp</code></pre>
<pre><code>## class       : SpatialPolygonsDataFrame 
## features    : 2 
## extent      : 8265652, 8898467, 2280053, 3246484  (xmin, xmax, ymin, ymax)
## coord. ref. : +proj=moll +lon_0=0 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0 
## variables   : 7
## names       : rgn_typ, ant_typ, rgn_id, ant_id,    rgn_nam, rgn_key,   are_km2 
## min values  :     eez,     eez,    204,    204, Bangladesh,     BGD, 139812.14 
## max values  :    land,    land,    204,    204, Bangladesh,     BGD,  84563.26</code></pre>
<p>Now we can crop our mangrove data layer using the <code>crop()</code> function from the <code>raster</code> package. This function takes the raster data you want to crop (in our case it is <code>mangrove</code>) and the shapefile from which to get the coordinates for cropping (<code>bang_sp</code>).</p>
<pre class="r"><code>bang_man &lt;- crop(mangrove, bang_sp)
plot(bang_man, axes = F)
plot(bang_sp, add = T, box = F, axes = F)</code></pre>
<p><img src="/post/2018-04-18-cropping-rasters-down-to-size-mangroves_files/figure-html/crop_mangrove_data-1.png" width="672" /></p>
<p>This data is now much more manageable at the scale of this assessment. You see there is still some mangrove data that falls outside of Bangladesh. If you wish, you can retain just the data that falls within the shapefile by using <code>mask()</code> from the <code>raster</code> package.</p>
<pre class="r"><code>bang_man_mask &lt;- mask(bang_man, bang_sp)
plot(bang_man_mask, axes = F)
plot(bang_sp, add = T)</code></pre>
<p><img src="/post/2018-04-18-cropping-rasters-down-to-size-mangroves_files/figure-html/mask-1.png" width="672" /></p>
<p>Save this data using <code>writeRaster()</code>.</p>
<pre class="r"><code>writeRaster(bang_man_mask, filename = &quot;bangladesh_mangrove_data.tif&quot;)</code></pre>
<p>For a more thorough tutorial on working with raster data see my <a href="http://jafflerbach.github.io/spatial-analysis-R/"><em>Intro to Spatial Analysis in R</em></a>.</p>
<p>Happy cropping!</p>
</div>
